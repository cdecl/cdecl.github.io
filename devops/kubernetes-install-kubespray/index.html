<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubernetes install with kubespray | cdeclog</title><meta name=keywords content="kubernetes,k8s,kubespray,ansible,baremetal"><meta name=description content="Kubespray 를 이용한 Kubernetes 설치 (Baremetal)
사전준비
서버 노드 준비

3대 Node

192.168.28.15
192.168.28.16
192.168.28.17
서버 노드 환경설정 : kubernetes-101 참고

Swap 영역을 비활성화
SELinux Disable
방화벽 Disable
브릿지 네트워크 할성화
설치 노드에서의 ssh 접속 허용 : SSH 키복사 ssh-copy-id

설치 준비

Git : Repository Clone
Python3 : Inventory 및 환경 설정을 위한 스크립트 실행
Ansible : 원격 실행(설치) ansible-playbook


Repository clone 및 Python package install

$ git clone https://github.com/kubernetes-sigs/kubespray
$ cd kubespray

# Package install
$ pip3 install -r requirements.txt

설치 방법 1 : inventory_builder

inventory_builder Python script 활용 inventory 구성 및 설치"><meta name=author content="Byung Kyu KIM"><link rel=canonical href=https://cdecl.github.io/devops/kubernetes-install-kubespray/><link crossorigin=anonymous href=/assets/css/stylesheet.94cdd6e6bf254a927ddb1a5b8ae2c24a30232449c016f55d87efd0d9bed87c55.css integrity="sha256-lM3W5r8lSpJ92xpbiuLCSjAjJEnAFvVdh+/Q2b7YfFU=" rel="preload stylesheet" as=style><link rel=icon href=https://cdecl.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cdecl.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cdecl.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://cdecl.github.io/apple-touch-icon.png><link rel=mask-icon href=https://cdecl.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://cdecl.github.io/devops/kubernetes-install-kubespray/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VQQHHYPN7K"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VQQHHYPN7K")}</script><meta property="og:url" content="https://cdecl.github.io/devops/kubernetes-install-kubespray/"><meta property="og:site_name" content="cdeclog"><meta property="og:title" content="Kubernetes install with kubespray"><meta property="og:description" content="Kubespray 를 이용한 Kubernetes 설치 (Baremetal)
사전준비 서버 노드 준비 3대 Node 192.168.28.15 192.168.28.16 192.168.28.17 서버 노드 환경설정 : kubernetes-101 참고 Swap 영역을 비활성화 SELinux Disable 방화벽 Disable 브릿지 네트워크 할성화 설치 노드에서의 ssh 접속 허용 : SSH 키복사 ssh-copy-id 설치 준비 Git : Repository Clone Python3 : Inventory 및 환경 설정을 위한 스크립트 실행 Ansible : 원격 실행(설치) ansible-playbook Repository clone 및 Python package install
$ git clone https://github.com/kubernetes-sigs/kubespray $ cd kubespray # Package install $ pip3 install -r requirements.txt 설치 방법 1 : inventory_builder inventory_builder Python script 활용 inventory 구성 및 설치"><meta property="og:locale" content="ko-kr"><meta property="og:type" content="article"><meta property="article:section" content="devops"><meta property="article:published_time" content="2021-09-13T00:00:00+09:00"><meta property="article:modified_time" content="2021-09-13T00:00:00+09:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="K8s"><meta property="article:tag" content="Kubespray"><meta property="article:tag" content="Ansible"><meta property="article:tag" content="Baremetal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes install with kubespray"><meta name=twitter:description content="Kubespray 를 이용한 Kubernetes 설치 (Baremetal)
사전준비
서버 노드 준비

3대 Node

192.168.28.15
192.168.28.16
192.168.28.17
서버 노드 환경설정 : kubernetes-101 참고

Swap 영역을 비활성화
SELinux Disable
방화벽 Disable
브릿지 네트워크 할성화
설치 노드에서의 ssh 접속 허용 : SSH 키복사 ssh-copy-id

설치 준비

Git : Repository Clone
Python3 : Inventory 및 환경 설정을 위한 스크립트 실행
Ansible : 원격 실행(설치) ansible-playbook


Repository clone 및 Python package install

$ git clone https://github.com/kubernetes-sigs/kubespray
$ cd kubespray

# Package install
$ pip3 install -r requirements.txt

설치 방법 1 : inventory_builder

inventory_builder Python script 활용 inventory 구성 및 설치"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Devops","item":"https://cdecl.github.io/devops/"},{"@type":"ListItem","position":2,"name":"Kubernetes install with kubespray","item":"https://cdecl.github.io/devops/kubernetes-install-kubespray/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes install with kubespray","name":"Kubernetes install with kubespray","description":"Kubespray 를 이용한 Kubernetes 설치 (Baremetal)\n사전준비 서버 노드 준비 3대 Node 192.168.28.15 192.168.28.16 192.168.28.17 서버 노드 환경설정 : kubernetes-101 참고 Swap 영역을 비활성화 SELinux Disable 방화벽 Disable 브릿지 네트워크 할성화 설치 노드에서의 ssh 접속 허용 : SSH 키복사 ssh-copy-id 설치 준비 Git : Repository Clone Python3 : Inventory 및 환경 설정을 위한 스크립트 실행 Ansible : 원격 실행(설치) ansible-playbook Repository clone 및 Python package install\n$ git clone https://github.com/kubernetes-sigs/kubespray $ cd kubespray # Package install $ pip3 install -r requirements.txt 설치 방법 1 : inventory_builder inventory_builder Python script 활용 inventory 구성 및 설치\n","keywords":["kubernetes","k8s","kubespray","ansible","baremetal"],"articleBody":"Kubespray 를 이용한 Kubernetes 설치 (Baremetal)\n사전준비 서버 노드 준비 3대 Node 192.168.28.15 192.168.28.16 192.168.28.17 서버 노드 환경설정 : kubernetes-101 참고 Swap 영역을 비활성화 SELinux Disable 방화벽 Disable 브릿지 네트워크 할성화 설치 노드에서의 ssh 접속 허용 : SSH 키복사 ssh-copy-id 설치 준비 Git : Repository Clone Python3 : Inventory 및 환경 설정을 위한 스크립트 실행 Ansible : 원격 실행(설치) ansible-playbook Repository clone 및 Python package install\n$ git clone https://github.com/kubernetes-sigs/kubespray $ cd kubespray # Package install $ pip3 install -r requirements.txt 설치 방법 1 : inventory_builder inventory_builder Python script 활용 inventory 구성 및 설치\n# Install 을 위한 Inventory 생성을 위한 공간 생성(복사) $ cp -rfp inventory/sample inventory/glass # IP 3개 지정, Node 설정 → inventory/glass/hosts.yaml $ declare -a IPS=(192.168.28.15 192.168.28.16 192.168.28.17) $ CONFIG_FILE=inventory/glass/hosts.yaml python3 contrib/inventory_builder/inventory.py ${IPS[@]} DEBUG: Adding group all DEBUG: Adding group kube_control_plane DEBUG: Adding group kube_node DEBUG: Adding group etcd DEBUG: Adding group k8s_cluster DEBUG: Adding group calico_rr DEBUG: adding host node1 to group all DEBUG: adding host node2 to group all DEBUG: adding host node3 to group all DEBUG: adding host node1 to group etcd DEBUG: adding host node2 to group etcd DEBUG: adding host node3 to group etcd DEBUG: adding host node1 to group kube_control_plane DEBUG: adding host node2 to group kube_control_plane DEBUG: adding host node1 to group kube_node DEBUG: adding host node2 to group kube_node DEBUG: adding host node3 to group kube_node # inventory 자동 구성 - 3개 노드 # kube_control_plane: node1,node2 # workder: node3 $ cat inventory/glass/hosts.yaml all: hosts: node1: ansible_host: 192.168.28.15 ip: 192.168.28.15 access_ip: 192.168.28.15 node2: ansible_host: 192.168.28.16 ip: 192.168.28.16 access_ip: 192.168.28.16 node3: ansible_host: 192.168.28.17 ip: 192.168.28.17 access_ip: 192.168.28.17 children: kube_control_plane: hosts: node1: node2: kube_node: hosts: node1: node2: node3: etcd: hosts: node1: node2: node3: k8s_cluster: children: kube_control_plane: kube_node: calico_rr: hosts: {} ## Install // 오래 걸림 $ ansible-playbook -i inventory/glass/hosts.yaml --become --become-user=root cluster.yml Cluster 확인 $ kubectl get node NAME STATUS ROLES AGE VERSION node1 Ready control-plane,master 40m v1.18.6 node2 Ready control-plane,master 40m v1.18.6 node3 Ready 38m v1.18.6 $ kubectl get pod -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-8575b76f66-kx2sv 0/1 CrashLoopBackOff 12 40m kube-system calico-node-g9xmm 1/1 Running 0 40m kube-system calico-node-pg7dt 1/1 Running 0 40m kube-system calico-node-rwbcf 1/1 Running 0 40m kube-system coredns-8474476ff8-26p2b 1/1 Running 0 39m kube-system coredns-8474476ff8-j5k4w 1/1 Running 0 39m kube-system dns-autoscaler-7df78bfcfb-7r474 1/1 Running 0 39m kube-system kube-apiserver-node1 1/1 Running 0 42m kube-system kube-apiserver-node2 1/1 Running 0 41m kube-system kube-controller-manager-node1 1/1 Running 0 42m kube-system kube-controller-manager-node2 1/1 Running 0 41m kube-system kube-proxy-4lqh5 1/1 Running 0 40m kube-system kube-proxy-6tg8t 1/1 Running 0 40m kube-system kube-proxy-brljv 1/1 Running 0 40m kube-system kube-scheduler-node1 1/1 Running 0 42m kube-system kube-scheduler-node2 1/1 Running 0 41m kube-system nginx-proxy-node3 1/1 Running 0 40m kube-system nodelocaldns-76jw6 1/1 Running 0 39m kube-system nodelocaldns-k87js 1/1 Running 0 39m kube-system nodelocaldns-lnlqt 1/1 Running 0 39m 서비스 설치 및 확인 mvcapp-deploy-service.yaml apiVersion: apps/v1 kind: Deployment metadata: name: mvcapp spec: selector: matchLabels: app: mvcapp replicas: 4 template: metadata: labels: app: mvcapp spec: containers: - name: mvcapp image: cdecl/mvcapp:0.6 imagePullPolicy: Always ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: mvcapp spec: type: NodePort selector: app: mvcapp ports: - port: 80 targetPort: 80 nodePort: 30010 $ kubectl apply -f mvcapp-deploy-service.yaml deployment.apps/mvcapp created service/mvcapp created $ kubectl get pod -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES mvcapp-5c56c55f76-c245s 1/1 Running 0 44s 10.233.96.4 node2 mvcapp-5c56c55f76-nt7bw 1/1 Running 0 44s 10.233.92.5 node3 mvcapp-5c56c55f76-pjr8c 1/1 Running 0 44s 10.233.96.3 node2 mvcapp-5c56c55f76-xthgs 1/1 Running 0 44s 10.233.92.6 node3 ] $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.233.0.1 443/TCP 8m42s mvcapp NodePort 10.233.12.111 80:30010/TCP 83s # cluster ip 로 호출 $ curl -s 10.233.12.111:80 * Project : mvcapp * Version : 0.6 / net5.0 * Hostname : mvcapp-5c56c55f76-frbfs * Sleep(sync) : 0 * RemoteAddr : 10.233.90.0 * X-Forwarded-For : * Request Count : 1 * User-Agent : curl/7.29.0 # node port (kube-proxy) 호출 $ curl -s node1:30010 * Project : mvcapp * Version : 0.6 / net5.0 * Hostname : mvcapp-5c56c55f76-c82ws * Sleep(sync) : 0 * RemoteAddr : 10.233.90.0 * X-Forwarded-For : * Request Count : 1 * User-Agent : curl/7.29.0 설치 방법 2 : inventory 직접 수정 inventory.ini 수정 및 설치\n# Install 을 위한 Inventory 생성을 위한 공간 생성(복사) $ cp -rfp inventory/sample inventory/glass inventory/glass/inventory.ini kube_control_plane 1개만 설정 : node1 # ## Configure 'ip' variable to bind kubernetes services on a # ## different ip than the default iface # ## We should set etcd_member_name for etcd cluster. The node that is not a etcd member do not need to set the value, or can set the empty string value. [all] node1 ansible_host=192.168.28.15 node2 ansible_host=192.168.28.16 node3 ansible_host=192.168.28.17 # ## configure a bastion host if your nodes are not directly reachable # [bastion] # bastion ansible_host=x.x.x.x ansible_user=some_user [kube_control_plane] node1 [etcd] node1 node2 node3 [kube_node] node2 node3 # node4 # node5 # node6 [calico_rr] [k8s_cluster:children] kube_control_plane kube_node calico_rr ## Install $ ansible-playbook -i inventory/glass/inventory.ini --become --become-user=root cluster.yml Cluster 확인 $ kubectl get node NAME STATUS ROLES AGE VERSION node1 Ready control-plane,master 3m41s v1.18.6 node2 Ready 2m37s v1.18.6 node3 Ready 2m38s v1.18.6 $ kubectl get pod -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-8575b76f66-nm6ll 0/1 CrashLoopBackOff 5 4m35s kube-system calico-node-9xqmz 1/1 Running 0 4m55s kube-system calico-node-dbr4p 1/1 Running 0 4m55s kube-system calico-node-h4xcv 1/1 Running 0 4m55s kube-system coredns-8474476ff8-6rx9f 1/1 Running 0 4m20s kube-system coredns-8474476ff8-r7nrf 1/1 Running 0 4m15s kube-system dns-autoscaler-7df78bfcfb-g482g 1/1 Running 0 4m17s kube-system kube-apiserver-node1 1/1 Running 0 6m6s kube-system kube-controller-manager-node1 1/1 Running 0 6m6s kube-system kube-proxy-6rxsz 1/1 Running 0 5m12s kube-system kube-proxy-jt2dl 1/1 Running 0 5m12s kube-system kube-proxy-kdxch 1/1 Running 0 5m12s kube-system kube-scheduler-node1 1/1 Running 0 6m6s kube-system nginx-proxy-node2 1/1 Running 0 5m12s kube-system nginx-proxy-node3 1/1 Running 0 5m12s kube-system nodelocaldns-2tjm8 1/1 Running 0 4m16s kube-system nodelocaldns-pzkjq 1/1 Running 0 4m16s kube-system nodelocaldns-r9gbv 1/1 Running 0 4m16s $ kubectl apply -f mvcapp-deploy-service.yaml deployment.apps/mvcapp created service/mvcapp created $ kubectl get pod -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES mvcapp-5c56c55f76-c82ws 1/1 Running 0 48s 10.233.96.3 node2 mvcapp-5c56c55f76-frbfs 1/1 Running 0 48s 10.233.92.2 node3 mvcapp-5c56c55f76-kx2bm 1/1 Running 0 48s 10.233.96.2 node2 mvcapp-5c56c55f76-xvlbp 1/1 Running 0 48s 10.233.92.1 node3 클러스터 고가용성 구조 https://github.com/kubernetes-sigs/kubespray/blob/master/docs/ha-mode.md{:target=\"_blank\"} Etcd 클러스터 구성 Kube-apiserver kubeadm 고가용성 구조의 경우 kube-apiserver 서버접근을 위한 HA (loadbalancer) 가 필요 kubespray 의 경우 nginx-based 기반 reverse proxy 각 node 에 내장되어 있어서 별도 LB 구성이 필요 없음 local internal loadbalancer 를 사용하지 않은 경우 별도 HA 구성 가능 Node 추가 및 Cluster 변경 https://github.com/kubernetes-sigs/kubespray/blob/master/docs/nodes.md{:target=\"_blank\"} 1) Control-plane 변경 Change order of current control planes Upgrade the cluster inventory 수정 후, cluster.yml 실행\n$ ansible-playbook -i inventory/glass/hosts.yaml cluster.yml 2) Adding/replacing a worker node inventory 수정 후, scale.yml 실행\n# 전체 갱신 $ ansible-playbook -i inventory/glass/hosts.yaml scale.yml # 추가된 node3 만 갱신 $ ansible-playbook -i inventory/glass/hosts.yaml scale.yml --limit=node3 3) Remove a worker node $ ansible-playbook -i inventory/glass/hosts.yaml remove-node.yml -e node=node3 ... $ kubectl get node NAME STATUS ROLES AGE VERSION node1 Ready control-plane,master 86m v1.18.6 node2 Ready control-plane,master 85m v1.18.6 node3 NotReady,SchedulingDisabled 19m v1.18.6 $ kubectl delete node node3 node \"node3\" deleted $ kubectl get node NAME STATUS ROLES AGE VERSION node1 Ready control-plane,master 88m v1.18.6 node2 Ready control-plane,master 87m v1.18.6 초기화 : 클러스터 삭제 $ ansible-playbook -i inventory/glass/hosts.yaml --become --become-user=root reset.yml ","wordCount":"1207","inLanguage":"en","datePublished":"2021-09-13T00:00:00+09:00","dateModified":"2021-09-13T00:00:00+09:00","author":{"@type":"Person","name":"Byung Kyu KIM"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://cdecl.github.io/devops/kubernetes-install-kubespray/"},"publisher":{"@type":"Organization","name":"cdeclog","logo":{"@type":"ImageObject","url":"https://cdecl.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://cdecl.github.io/ accesskey=h title="cdeclog (Alt + H)">cdeclog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://cdecl.github.io/dev/ title=Dev><span>Dev</span></a></li><li><a href=https://cdecl.github.io/devops/ title=DevOps><span>DevOps</span></a></li><li><a href=https://cdecl.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://cdecl.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://cdecl.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Kubernetes install with kubespray</h1><div class=post-meta><span title='2021-09-13 00:00:00 +0900 KST'>September 13, 2021</span>&nbsp;·&nbsp;<span>Byung Kyu KIM</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%ec%82%ac%ec%a0%84%ec%a4%80%eb%b9%84 aria-label=사전준비>사전준비</a><ul><li><a href=#%ec%84%9c%eb%b2%84-%eb%85%b8%eb%93%9c-%ec%a4%80%eb%b9%84 aria-label="서버 노드 준비">서버 노드 준비</a></li><li><a href=#%ec%84%9c%eb%b2%84-%eb%85%b8%eb%93%9c-%ed%99%98%ea%b2%bd%ec%84%a4%ec%a0%95--kubernetes-101-%ec%b0%b8%ea%b3%a0 aria-label="서버 노드 환경설정 : kubernetes-101 참고">서버 노드 환경설정 : kubernetes-101 참고</a></li><li><a href=#%ec%84%a4%ec%b9%98-%ec%a4%80%eb%b9%84 aria-label="설치 준비">설치 준비</a></li></ul></li><li><a href=#%ec%84%a4%ec%b9%98-%eb%b0%a9%eb%b2%95-1--inventory_builder aria-label="설치 방법 1 : inventory_builder">설치 방법 1 : inventory_builder</a><ul><li><a href=#cluster-%ed%99%95%ec%9d%b8 aria-label="Cluster 확인">Cluster 확인</a></li><li><a href=#%ec%84%9c%eb%b9%84%ec%8a%a4-%ec%84%a4%ec%b9%98-%eb%b0%8f-%ed%99%95%ec%9d%b8 aria-label="서비스 설치 및 확인">서비스 설치 및 확인</a></li></ul></li><li><a href=#%ec%84%a4%ec%b9%98-%eb%b0%a9%eb%b2%95-2--inventory-%ec%a7%81%ec%a0%91-%ec%88%98%ec%a0%95 aria-label="설치 방법 2 : inventory 직접 수정">설치 방법 2 : inventory 직접 수정</a><ul><li><a href=#cluster-%ed%99%95%ec%9d%b8-1 aria-label="Cluster 확인">Cluster 확인</a></li></ul></li><li><a href=#%ed%81%b4%eb%9f%ac%ec%8a%a4%ed%84%b0-%ea%b3%a0%ea%b0%80%ec%9a%a9%ec%84%b1-%ea%b5%ac%ec%a1%b0 aria-label="클러스터 고가용성 구조">클러스터 고가용성 구조</a><ul><li><a href=#etcd-%ed%81%b4%eb%9f%ac%ec%8a%a4%ed%84%b0-%ea%b5%ac%ec%84%b1 aria-label="Etcd 클러스터 구성">Etcd 클러스터 구성</a></li><li><a href=#kube-apiserver aria-label=Kube-apiserver>Kube-apiserver</a></li></ul></li><li><a href=#node-%ec%b6%94%ea%b0%80-%eb%b0%8f-cluster-%eb%b3%80%ea%b2%bd aria-label="Node 추가 및 Cluster 변경">Node 추가 및 Cluster 변경</a><ul><ul><li><a href=#1-control-plane-%eb%b3%80%ea%b2%bd aria-label="1) Control-plane 변경">1) Control-plane 변경</a></li><li><a href=#2-addingreplacing-a-worker-node aria-label="2) Adding/replacing a worker node">2) Adding/replacing a worker node</a></li><li><a href=#3-remove-a-worker-node aria-label="3) Remove a worker node">3) Remove a worker node</a></li></ul><li><a href=#%ec%b4%88%ea%b8%b0%ed%99%94--%ed%81%b4%eb%9f%ac%ec%8a%a4%ed%84%b0-%ec%82%ad%ec%a0%9c aria-label="초기화 : 클러스터 삭제">초기화 : 클러스터 삭제</a></li></ul></li></ul></div></details></div><div class=post-content><p>Kubespray 를 이용한 Kubernetes 설치 (Baremetal)</p><h2 id=사전준비>사전준비<a hidden class=anchor aria-hidden=true href=#사전준비>#</a></h2><h3 id=서버-노드-준비>서버 노드 준비<a hidden class=anchor aria-hidden=true href=#서버-노드-준비>#</a></h3><ul><li>3대 Node</li></ul><pre tabindex=0><code>192.168.28.15
192.168.28.16
192.168.28.17
</code></pre><h3 :target=_blank id=서버-노드-환경설정--kubernetes-101-참고>서버 노드 환경설정 : <a href=/devops/kubernetes-101/>kubernetes-101 참고</a></h3><ul><li>Swap 영역을 비활성화</li><li>SELinux Disable</li><li>방화벽 Disable</li><li>브릿지 네트워크 할성화</li><li>설치 노드에서의 ssh 접속 허용 : SSH 키복사 <code>ssh-copy-id</code></li></ul><h3 id=설치-준비>설치 준비<a hidden class=anchor aria-hidden=true href=#설치-준비>#</a></h3><ul><li>Git : Repository Clone</li><li>Python3 : Inventory 및 환경 설정을 위한 스크립트 실행</li><li>Ansible : 원격 실행(설치) <code>ansible-playbook</code></li></ul><blockquote><p>Repository clone 및 Python package install</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ git clone https://github.com/kubernetes-sigs/kubespray
</span></span><span style=display:flex><span>$ cd kubespray
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Package install</span>
</span></span><span style=display:flex><span>$ pip3 install -r requirements.txt
</span></span></code></pre></div><hr><h2 id=설치-방법-1--inventory_builder>설치 방법 1 : <code>inventory_builder</code><a hidden class=anchor aria-hidden=true href=#설치-방법-1--inventory_builder>#</a></h2><blockquote><p><code>inventory_builder</code> Python script 활용 inventory 구성 및 설치</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># Install 을 위한 Inventory 생성을 위한 공간 생성(복사)</span>
</span></span><span style=display:flex><span>$ cp -rfp inventory/sample inventory/glass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># IP 3개 지정, Node 설정 → inventory/glass/hosts.yaml</span>
</span></span><span style=display:flex><span>$ declare -a IPS<span style=color:#f92672>=(</span>192.168.28.15 192.168.28.16 192.168.28.17<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ CONFIG_FILE<span style=color:#f92672>=</span>inventory/glass/hosts.yaml python3 contrib/inventory_builder/inventory.py <span style=color:#e6db74>${</span>IPS[@]<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>DEBUG: Adding group all
</span></span><span style=display:flex><span>DEBUG: Adding group kube_control_plane
</span></span><span style=display:flex><span>DEBUG: Adding group kube_node
</span></span><span style=display:flex><span>DEBUG: Adding group etcd
</span></span><span style=display:flex><span>DEBUG: Adding group k8s_cluster
</span></span><span style=display:flex><span>DEBUG: Adding group calico_rr
</span></span><span style=display:flex><span>DEBUG: adding host node1 to group all
</span></span><span style=display:flex><span>DEBUG: adding host node2 to group all
</span></span><span style=display:flex><span>DEBUG: adding host node3 to group all
</span></span><span style=display:flex><span>DEBUG: adding host node1 to group etcd
</span></span><span style=display:flex><span>DEBUG: adding host node2 to group etcd
</span></span><span style=display:flex><span>DEBUG: adding host node3 to group etcd
</span></span><span style=display:flex><span>DEBUG: adding host node1 to group kube_control_plane
</span></span><span style=display:flex><span>DEBUG: adding host node2 to group kube_control_plane
</span></span><span style=display:flex><span>DEBUG: adding host node1 to group kube_node
</span></span><span style=display:flex><span>DEBUG: adding host node2 to group kube_node
</span></span><span style=display:flex><span>DEBUG: adding host node3 to group kube_node
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># inventory 자동 구성 - 3개 노드 </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   kube_control_plane: node1,node2 </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   workder: node3</span>
</span></span><span style=display:flex><span>$ cat inventory/glass/hosts.yaml
</span></span><span style=display:flex><span>all:
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>    node1:
</span></span><span style=display:flex><span>      ansible_host: 192.168.28.15
</span></span><span style=display:flex><span>      ip: 192.168.28.15
</span></span><span style=display:flex><span>      access_ip: 192.168.28.15
</span></span><span style=display:flex><span>    node2:
</span></span><span style=display:flex><span>      ansible_host: 192.168.28.16
</span></span><span style=display:flex><span>      ip: 192.168.28.16
</span></span><span style=display:flex><span>      access_ip: 192.168.28.16
</span></span><span style=display:flex><span>    node3:
</span></span><span style=display:flex><span>      ansible_host: 192.168.28.17
</span></span><span style=display:flex><span>      ip: 192.168.28.17
</span></span><span style=display:flex><span>      access_ip: 192.168.28.17
</span></span><span style=display:flex><span>  children:
</span></span><span style=display:flex><span>    kube_control_plane:
</span></span><span style=display:flex><span>      hosts:
</span></span><span style=display:flex><span>        node1:
</span></span><span style=display:flex><span>        node2:
</span></span><span style=display:flex><span>    kube_node:
</span></span><span style=display:flex><span>      hosts:
</span></span><span style=display:flex><span>        node1:
</span></span><span style=display:flex><span>        node2:
</span></span><span style=display:flex><span>        node3:
</span></span><span style=display:flex><span>    etcd:
</span></span><span style=display:flex><span>      hosts:
</span></span><span style=display:flex><span>        node1:
</span></span><span style=display:flex><span>        node2:
</span></span><span style=display:flex><span>        node3:
</span></span><span style=display:flex><span>    k8s_cluster:
</span></span><span style=display:flex><span>      children:
</span></span><span style=display:flex><span>        kube_control_plane:
</span></span><span style=display:flex><span>        kube_node:
</span></span><span style=display:flex><span>    calico_rr:
</span></span><span style=display:flex><span>      hosts: <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Install // 오래 걸림 </span>
</span></span><span style=display:flex><span>$ ansible-playbook -i inventory/glass/hosts.yaml  --become --become-user<span style=color:#f92672>=</span>root cluster.yml
</span></span></code></pre></div><h3 id=cluster-확인>Cluster 확인<a hidden class=anchor aria-hidden=true href=#cluster-확인>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl get node
</span></span><span style=display:flex><span>NAME    STATUS   ROLES                  AGE   VERSION
</span></span><span style=display:flex><span>node1   Ready    control-plane,master   40m   v1.18.6
</span></span><span style=display:flex><span>node2   Ready    control-plane,master   40m   v1.18.6
</span></span><span style=display:flex><span>node3   Ready    &lt;none&gt;                 38m   v1.18.6
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get pod -A
</span></span><span style=display:flex><span>NAMESPACE     NAME                                       READY   STATUS             RESTARTS   AGE
</span></span><span style=display:flex><span>kube-system   calico-kube-controllers-8575b76f66-kx2sv   0/1     CrashLoopBackOff   <span style=color:#ae81ff>12</span>         40m
</span></span><span style=display:flex><span>kube-system   calico-node-g9xmm                          1/1     Running            <span style=color:#ae81ff>0</span>          40m
</span></span><span style=display:flex><span>kube-system   calico-node-pg7dt                          1/1     Running            <span style=color:#ae81ff>0</span>          40m
</span></span><span style=display:flex><span>kube-system   calico-node-rwbcf                          1/1     Running            <span style=color:#ae81ff>0</span>          40m
</span></span><span style=display:flex><span>kube-system   coredns-8474476ff8-26p2b                   1/1     Running            <span style=color:#ae81ff>0</span>          39m
</span></span><span style=display:flex><span>kube-system   coredns-8474476ff8-j5k4w                   1/1     Running            <span style=color:#ae81ff>0</span>          39m
</span></span><span style=display:flex><span>kube-system   dns-autoscaler-7df78bfcfb-7r474            1/1     Running            <span style=color:#ae81ff>0</span>          39m
</span></span><span style=display:flex><span>kube-system   kube-apiserver-node1                       1/1     Running            <span style=color:#ae81ff>0</span>          42m
</span></span><span style=display:flex><span>kube-system   kube-apiserver-node2                       1/1     Running            <span style=color:#ae81ff>0</span>          41m
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-node1              1/1     Running            <span style=color:#ae81ff>0</span>          42m
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-node2              1/1     Running            <span style=color:#ae81ff>0</span>          41m
</span></span><span style=display:flex><span>kube-system   kube-proxy-4lqh5                           1/1     Running            <span style=color:#ae81ff>0</span>          40m
</span></span><span style=display:flex><span>kube-system   kube-proxy-6tg8t                           1/1     Running            <span style=color:#ae81ff>0</span>          40m
</span></span><span style=display:flex><span>kube-system   kube-proxy-brljv                           1/1     Running            <span style=color:#ae81ff>0</span>          40m
</span></span><span style=display:flex><span>kube-system   kube-scheduler-node1                       1/1     Running            <span style=color:#ae81ff>0</span>          42m
</span></span><span style=display:flex><span>kube-system   kube-scheduler-node2                       1/1     Running            <span style=color:#ae81ff>0</span>          41m
</span></span><span style=display:flex><span>kube-system   nginx-proxy-node3                          1/1     Running            <span style=color:#ae81ff>0</span>          40m
</span></span><span style=display:flex><span>kube-system   nodelocaldns-76jw6                         1/1     Running            <span style=color:#ae81ff>0</span>          39m
</span></span><span style=display:flex><span>kube-system   nodelocaldns-k87js                         1/1     Running            <span style=color:#ae81ff>0</span>          39m
</span></span><span style=display:flex><span>kube-system   nodelocaldns-lnlqt                         1/1     Running            <span style=color:#ae81ff>0</span>          39m
</span></span></code></pre></div><h3 id=서비스-설치-및-확인>서비스 설치 및 확인<a hidden class=anchor aria-hidden=true href=#서비스-설치-및-확인>#</a></h3><ul><li>mvcapp-deploy-service.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mvcapp</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>mvcapp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>4</span> 
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>: 
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>mvcapp</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mvcapp</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>cdecl/mvcapp:0.6</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mvcapp</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>mvcapp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30010</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f mvcapp-deploy-service.yaml
</span></span><span style=display:flex><span>deployment.apps/mvcapp created
</span></span><span style=display:flex><span>service/mvcapp created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get pod -owide
</span></span><span style=display:flex><span>NAME                      READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>mvcapp-5c56c55f76-c245s   1/1     Running   <span style=color:#ae81ff>0</span>          44s   10.233.96.4   node2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>mvcapp-5c56c55f76-nt7bw   1/1     Running   <span style=color:#ae81ff>0</span>          44s   10.233.92.5   node3   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>mvcapp-5c56c55f76-pjr8c   1/1     Running   <span style=color:#ae81ff>0</span>          44s   10.233.96.3   node2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>mvcapp-5c56c55f76-xthgs   1/1     Running   <span style=color:#ae81ff>0</span>          44s   10.233.92.6   node3   &lt;none&gt;           &lt;none&gt;<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get svc
</span></span><span style=display:flex><span>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE
</span></span><span style=display:flex><span>kubernetes   ClusterIP   10.233.0.1      &lt;none&gt;        443/TCP        8m42s
</span></span><span style=display:flex><span>mvcapp       NodePort    10.233.12.111   &lt;none&gt;        80:30010/TCP   83s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># cluster ip 로 호출</span>
</span></span><span style=display:flex><span>$ curl -s 10.233.12.111:80
</span></span><span style=display:flex><span>    * Project           : mvcapp
</span></span><span style=display:flex><span>    * Version           : 0.6 / net5.0
</span></span><span style=display:flex><span>    * Hostname          : mvcapp-5c56c55f76-frbfs
</span></span><span style=display:flex><span>    * Sleep<span style=color:#f92672>(</span>sync<span style=color:#f92672>)</span>       : <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    * RemoteAddr        : 10.233.90.0
</span></span><span style=display:flex><span>    * X-Forwarded-For   : 
</span></span><span style=display:flex><span>    * Request Count     : <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    * User-Agent        : curl/7.29.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># node port (kube-proxy) 호출 </span>
</span></span><span style=display:flex><span>$ curl -s node1:30010
</span></span><span style=display:flex><span>    * Project           : mvcapp
</span></span><span style=display:flex><span>    * Version           : 0.6 / net5.0
</span></span><span style=display:flex><span>    * Hostname          : mvcapp-5c56c55f76-c82ws
</span></span><span style=display:flex><span>    * Sleep<span style=color:#f92672>(</span>sync<span style=color:#f92672>)</span>       : <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    * RemoteAddr        : 10.233.90.0
</span></span><span style=display:flex><span>    * X-Forwarded-For   : 
</span></span><span style=display:flex><span>    * Request Count     : <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    * User-Agent        : curl/7.29.0
</span></span></code></pre></div><hr><h2 id=설치-방법-2--inventory-직접-수정>설치 방법 2 : inventory 직접 수정<a hidden class=anchor aria-hidden=true href=#설치-방법-2--inventory-직접-수정>#</a></h2><blockquote><p>inventory.ini 수정 및 설치</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># Install 을 위한 Inventory 생성을 위한 공간 생성(복사)</span>
</span></span><span style=display:flex><span>$ cp -rfp inventory/sample inventory/glass
</span></span></code></pre></div><ul><li>inventory/glass/inventory.ini<ul><li><code>kube_control_plane</code> 1개만 설정 : <code>node1</code></li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># ## Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ## different ip than the default iface</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ## We should set etcd_member_name for etcd cluster. The node that is not a etcd member do not need to set the value, or can set the empty string value.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[all]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node1 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.28.15</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node2 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.28.16</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node3 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.28.17</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ## configure a bastion host if your nodes are not directly reachable</span>
</span></span><span style=display:flex><span><span style=color:#75715e># [bastion]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># bastion ansible_host=x.x.x.x ansible_user=some_user</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[kube_control_plane]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[etcd]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[kube_node]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>node3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># node4</span>
</span></span><span style=display:flex><span><span style=color:#75715e># node5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># node6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[calico_rr]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[k8s_cluster:children]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>kube_control_plane</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>kube_node</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>calico_rr</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>## Install</span>
</span></span><span style=display:flex><span>$ ansible-playbook -i inventory/glass/inventory.ini  --become --become-user<span style=color:#f92672>=</span>root cluster.yml
</span></span></code></pre></div><h3 id=cluster-확인-1>Cluster 확인<a hidden class=anchor aria-hidden=true href=#cluster-확인-1>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl get node
</span></span><span style=display:flex><span>NAME    STATUS   ROLES                  AGE     VERSION
</span></span><span style=display:flex><span>node1   Ready    control-plane,master   3m41s   v1.18.6
</span></span><span style=display:flex><span>node2   Ready    &lt;none&gt;                 2m37s   v1.18.6
</span></span><span style=display:flex><span>node3   Ready    &lt;none&gt;                 2m38s   v1.18.6
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get pod -A
</span></span><span style=display:flex><span>NAMESPACE     NAME                                       READY   STATUS             RESTARTS   AGE
</span></span><span style=display:flex><span>kube-system   calico-kube-controllers-8575b76f66-nm6ll   0/1     CrashLoopBackOff   <span style=color:#ae81ff>5</span>          4m35s
</span></span><span style=display:flex><span>kube-system   calico-node-9xqmz                          1/1     Running            <span style=color:#ae81ff>0</span>          4m55s
</span></span><span style=display:flex><span>kube-system   calico-node-dbr4p                          1/1     Running            <span style=color:#ae81ff>0</span>          4m55s
</span></span><span style=display:flex><span>kube-system   calico-node-h4xcv                          1/1     Running            <span style=color:#ae81ff>0</span>          4m55s
</span></span><span style=display:flex><span>kube-system   coredns-8474476ff8-6rx9f                   1/1     Running            <span style=color:#ae81ff>0</span>          4m20s
</span></span><span style=display:flex><span>kube-system   coredns-8474476ff8-r7nrf                   1/1     Running            <span style=color:#ae81ff>0</span>          4m15s
</span></span><span style=display:flex><span>kube-system   dns-autoscaler-7df78bfcfb-g482g            1/1     Running            <span style=color:#ae81ff>0</span>          4m17s
</span></span><span style=display:flex><span>kube-system   kube-apiserver-node1                       1/1     Running            <span style=color:#ae81ff>0</span>          6m6s
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-node1              1/1     Running            <span style=color:#ae81ff>0</span>          6m6s
</span></span><span style=display:flex><span>kube-system   kube-proxy-6rxsz                           1/1     Running            <span style=color:#ae81ff>0</span>          5m12s
</span></span><span style=display:flex><span>kube-system   kube-proxy-jt2dl                           1/1     Running            <span style=color:#ae81ff>0</span>          5m12s
</span></span><span style=display:flex><span>kube-system   kube-proxy-kdxch                           1/1     Running            <span style=color:#ae81ff>0</span>          5m12s
</span></span><span style=display:flex><span>kube-system   kube-scheduler-node1                       1/1     Running            <span style=color:#ae81ff>0</span>          6m6s
</span></span><span style=display:flex><span>kube-system   nginx-proxy-node2                          1/1     Running            <span style=color:#ae81ff>0</span>          5m12s
</span></span><span style=display:flex><span>kube-system   nginx-proxy-node3                          1/1     Running            <span style=color:#ae81ff>0</span>          5m12s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-2tjm8                         1/1     Running            <span style=color:#ae81ff>0</span>          4m16s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-pzkjq                         1/1     Running            <span style=color:#ae81ff>0</span>          4m16s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-r9gbv                         1/1     Running            <span style=color:#ae81ff>0</span>          4m16s
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f mvcapp-deploy-service.yaml
</span></span><span style=display:flex><span>deployment.apps/mvcapp created
</span></span><span style=display:flex><span>service/mvcapp created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get pod -owide
</span></span><span style=display:flex><span>NAME                      READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>mvcapp-5c56c55f76-c82ws   1/1     Running   <span style=color:#ae81ff>0</span>          48s   10.233.96.3   node2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>mvcapp-5c56c55f76-frbfs   1/1     Running   <span style=color:#ae81ff>0</span>          48s   10.233.92.2   node3   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>mvcapp-5c56c55f76-kx2bm   1/1     Running   <span style=color:#ae81ff>0</span>          48s   10.233.96.2   node2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>mvcapp-5c56c55f76-xvlbp   1/1     Running   <span style=color:#ae81ff>0</span>          48s   10.233.92.1   node3   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><hr><h2 id=클러스터-고가용성-구조>클러스터 고가용성 구조<a hidden class=anchor aria-hidden=true href=#클러스터-고가용성-구조>#</a></h2><ul><li><a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/ha-mode.md>https://github.com/kubernetes-sigs/kubespray/blob/master/docs/ha-mode.md</a>{:target="_blank"}</li></ul><h3 id=etcd-클러스터-구성>Etcd 클러스터 구성<a hidden class=anchor aria-hidden=true href=#etcd-클러스터-구성>#</a></h3><h3 id=kube-apiserver>Kube-apiserver<a hidden class=anchor aria-hidden=true href=#kube-apiserver>#</a></h3><ul><li>kubeadm 고가용성 구조의 경우 <code>kube-apiserver</code> 서버접근을 위한 HA (loadbalancer) 가 필요</li><li>kubespray 의 경우 <code>nginx-based</code> 기반 <code>reverse proxy</code> 각 node 에 내장되어 있어서 별도 LB 구성이 필요 없음<ul><li><code>local internal loadbalancer</code> 를 사용하지 않은 경우 별도 HA 구성 가능</li></ul></li></ul><hr><h2 id=node-추가-및-cluster-변경>Node 추가 및 Cluster 변경<a hidden class=anchor aria-hidden=true href=#node-추가-및-cluster-변경>#</a></h2><ul><li><a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/nodes.md>https://github.com/kubernetes-sigs/kubespray/blob/master/docs/nodes.md</a>{:target="_blank"}</li></ul><h4 id=1-control-plane-변경>1) Control-plane 변경<a hidden class=anchor aria-hidden=true href=#1-control-plane-변경>#</a></h4><ul><li>Change order of current control planes</li><li>Upgrade the cluster</li></ul><blockquote><p>inventory 수정 후, cluster.yml 실행</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ansible-playbook -i inventory/glass/hosts.yaml cluster.yml
</span></span></code></pre></div><h4 id=2-addingreplacing-a-worker-node>2) Adding/replacing a worker node<a hidden class=anchor aria-hidden=true href=#2-addingreplacing-a-worker-node>#</a></h4><blockquote><p>inventory 수정 후, scale.yml 실행</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 전체 갱신 </span>
</span></span><span style=display:flex><span>$ ansible-playbook -i inventory/glass/hosts.yaml scale.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 추가된 node3 만 갱신 </span>
</span></span><span style=display:flex><span>$ ansible-playbook -i inventory/glass/hosts.yaml scale.yml --limit<span style=color:#f92672>=</span>node3
</span></span></code></pre></div><h4 id=3-remove-a-worker-node>3) Remove a worker node<a hidden class=anchor aria-hidden=true href=#3-remove-a-worker-node>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ansible-playbook -i inventory/glass/hosts.yaml remove-node.yml -e node<span style=color:#f92672>=</span>node3
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get node
</span></span><span style=display:flex><span>NAME    STATUS                        ROLES                  AGE   VERSION
</span></span><span style=display:flex><span>node1   Ready                         control-plane,master   86m   v1.18.6
</span></span><span style=display:flex><span>node2   Ready                         control-plane,master   85m   v1.18.6
</span></span><span style=display:flex><span>node3   NotReady,SchedulingDisabled   &lt;none&gt;                 19m   v1.18.6
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl delete node node3
</span></span><span style=display:flex><span>node <span style=color:#e6db74>&#34;node3&#34;</span> deleted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get node
</span></span><span style=display:flex><span>NAME    STATUS   ROLES                  AGE   VERSION
</span></span><span style=display:flex><span>node1   Ready    control-plane,master   88m   v1.18.6
</span></span><span style=display:flex><span>node2   Ready    control-plane,master   87m   v1.18.6
</span></span></code></pre></div><hr><h3 id=초기화--클러스터-삭제>초기화 : 클러스터 삭제<a hidden class=anchor aria-hidden=true href=#초기화--클러스터-삭제>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ansible-playbook -i inventory/glass/hosts.yaml  --become --become-user<span style=color:#f92672>=</span>root reset.yml
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://cdecl.github.io/tags/kubernetes/>Kubernetes</a></li><li><a href=https://cdecl.github.io/tags/k8s/>K8s</a></li><li><a href=https://cdecl.github.io/tags/kubespray/>Kubespray</a></li><li><a href=https://cdecl.github.io/tags/ansible/>Ansible</a></li><li><a href=https://cdecl.github.io/tags/baremetal/>Baremetal</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://cdecl.github.io/>cdeclog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>