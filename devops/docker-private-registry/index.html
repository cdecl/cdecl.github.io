<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker Private Registry | cdeclog</title><meta name=keywords content="docker,registry"><meta name=description content='Docker Private Registry 구성
Registry 실행

docker-compose.yml

version: &#39;3&#39;

services:
  registry:
    image: registry
    container_name: registry
    restart: always
    ports:
      - 5000:5000
    environment:
      REGISTRY_HTTP_ADDR: 0.0.0.0:5000
    volumes:
      - registry:/var/lib/registry
      - ./config.yml:/etc/docker/registry/config.yml

volumes:
  registry:
# 실행
$ docker-compose up -d

$ curl -s http://localhost:5000/v2/_catalog
{"repositories":[]}

SSL 적용

version: &#39;3&#39;

services:
  registry:
    image: registry
    container_name: private_registry
    restart: always
    ports:
      - 5000:5000
    environment:
      REGISTRY_HTTP_ADDR: 0.0.0.0:5000
      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain-pem.pem
      REGISTRY_HTTP_TLS_KEY: /certs/domain-pem.key
    volumes:
      - registry:/var/lib/registry
      - ./config.yml:/etc/docker/registry/config.yml
      - ./certs:/certs

volumes:
  registry:
Image Push

테스트용 이미지 태깅

# get alpine images
$ docker pull alpine
$ docker pull alpine:3.13
# tagging
$ docker tag alpine localhost:5000/cdecl/alpine:latest
$ docker tag alpine:3.13 localhost:5000/cdecl/alpine:3.13

$ docker images
REPOSITORY                    TAG       IMAGE ID       CREATED        SIZE
alpine                        latest    ae607a46d002   2 weeks ago    5.33MB
localhost:5000/cdecl/alpine   latest    ae607a46d002   2 weeks ago    5.33MB
alpine                        3.13      81efc9693413   2 months ago   5.35MB
localhost:5000/cdecl/alpine   3.13      81efc9693413   2 months ago   5.35MB

Image Push

# image push 
$ docker push localhost:5000/cdecl/alpine:3.13
The push refers to repository [localhost:5000/cdecl/alpine]
c55d5dbdab40: Layer already exists
3.13: digest: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 size: 528

$ docker push localhost:5000/cdecl/alpine:latest
The push refers to repository [localhost:5000/cdecl/alpine]
5bfa694cc00a: Layer already exists
latest: digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e size: 528

# Catalog list 
$ curl -s http://localhost:5000/v2/_catalog
{"repositories":["cdecl/alpine"]}

# Tag 정보 
$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
{"name":"cdecl/alpine","tags":["latest","3.13"]}
Image Pull
$ docker pull localhost:5000/cdecl/alpine
Using default tag: latest
latest: Pulling from cdecl/alpine
Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e
Status: Downloaded newer image for localhost:5000/cdecl/alpine:latest
localhost:5000/cdecl/alpine:latest
Image Delete

Tag 확인 -> Manifests 확인 ->  Manifests 이미지 삭제

# Tag 정보 확인 
$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
{"name":"cdecl/alpine","tags":["latest","3.13"]}

# Tag의 Manifest 정보확인 - headers 확인 
# <registry-url>/v2/<image-path-name>/manifests/<tag>
$ curl -s -I -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
    http://localhost:5000/v2/cdecl/alpine/manifests/latest
HTTP/1.1 200 OK
Content-Length: 528
Content-Type: application/vnd.docker.distribution.manifest.v2+json
Docker-Content-Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e"


# Manifest 정보로 이미지 삭제 
# Docker-Content-Digest: <sha256:로 시작하는 해쉬 문자열> 
$ curl -s -XDELETE http://localhost:5000/v2/cdecl/alpine/manifests/sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e

# 확인
$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
{"name":"cdecl/alpine","tags":["3.13"]}
Delete marked manifests
$ curl -sS http://localhost:5000/v2/cdecl/alpine/tags/list
{"name":"cdecl/alpine","tags":null}

$ docker exec -it registry bin/registry garbage-collect /etc/docker/registry/config.yml
cdecl/alpine

0 blobs marked, 3 blobs and 0 manifests eligible for deletion
blob eligible for deletion: sha256:81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/81/81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802  go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry
blob eligible for deletion: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/55/55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4  go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry
blob eligible for deletion: sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/59/595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43  go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry

위 작업으로는 물리적인 데이터가 삭제 안됨

# 물리적인 파일 삭제 
$ docker exec -it registry rm -rf /var/lib/registry/docker/registry/v2/repositories/cdecl

Script

registry-image-delete.sh

#!/bin/bash

URI="$1"
NAME="$2"
TAG="$3"

if [[ -z "$URI" ]]; then
        echo "Usage: $0 <URI> <NAME> [<TAG>]"
        exit -1
fi

if [[ -z "$NAME" ]]; then
        echo "Usage: $0 $URI <NAME> [<TAG>]"
        echo
        curl -sS $URI/v2/_catalog | jq -r &#39;.repositories[]&#39;
        echo
        exit -1
fi

if [[ -z "$TAG" ]]; then
        echo "Usage: $0 $URI $NAME [<TAG>]"
        echo
        curl -sS $URI/v2/$NAME/tags/list | jq -r &#39;.tags[]&#39;
        echo
        exit -1
fi

MANIFESTS=$(curl -sS -I -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
        $URI/v2/$NAME/manifests/$TAG | grep -i Docker-Content-Digest | awk &#39;{print $2}&#39;)

if [[ -z "$MANIFESTS" ]]; then
        echo "No manifest found for $NAME:$TAG"
        exit -1
fi

echo $MANIFESTS
echo
echo curl -sS -XDELETE $URI/v2/$NAME/manifests/$MANIFESTS
echo
'><meta name=author content="Byung Kyu KIM"><link rel=canonical href=https://cdecl.github.io/devops/docker-private-registry/><link crossorigin=anonymous href=/assets/css/stylesheet.d980bb9fb2cba61af0aead0606b5eb221d7e358748ac394b60233d95d626c563.css integrity="sha256-2YC7n7LLphrwrq0GBrXrIh1+NYdIrDlLYCM9ldYmxWM=" rel="preload stylesheet" as=style><link rel=icon href=https://cdecl.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cdecl.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cdecl.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://cdecl.github.io/apple-touch-icon.png><link rel=mask-icon href=https://cdecl.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://cdecl.github.io/devops/docker-private-registry/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VQQHHYPN7K"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VQQHHYPN7K")}</script><meta property="og:url" content="https://cdecl.github.io/devops/docker-private-registry/"><meta property="og:site_name" content="cdeclog"><meta property="og:title" content="Docker Private Registry"><meta property="og:description" content='Docker Private Registry 구성
Registry 실행 docker-compose.yml version: &#39;3&#39; services: registry: image: registry container_name: registry restart: always ports: - 5000:5000 environment: REGISTRY_HTTP_ADDR: 0.0.0.0:5000 volumes: - registry:/var/lib/registry - ./config.yml:/etc/docker/registry/config.yml volumes: registry: # 실행 $ docker-compose up -d $ curl -s http://localhost:5000/v2/_catalog {"repositories":[]} SSL 적용 version: &#39;3&#39; services: registry: image: registry container_name: private_registry restart: always ports: - 5000:5000 environment: REGISTRY_HTTP_ADDR: 0.0.0.0:5000 REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain-pem.pem REGISTRY_HTTP_TLS_KEY: /certs/domain-pem.key volumes: - registry:/var/lib/registry - ./config.yml:/etc/docker/registry/config.yml - ./certs:/certs volumes: registry: Image Push 테스트용 이미지 태깅 # get alpine images $ docker pull alpine $ docker pull alpine:3.13 # tagging $ docker tag alpine localhost:5000/cdecl/alpine:latest $ docker tag alpine:3.13 localhost:5000/cdecl/alpine:3.13 $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE alpine latest ae607a46d002 2 weeks ago 5.33MB localhost:5000/cdecl/alpine latest ae607a46d002 2 weeks ago 5.33MB alpine 3.13 81efc9693413 2 months ago 5.35MB localhost:5000/cdecl/alpine 3.13 81efc9693413 2 months ago 5.35MB Image Push # image push $ docker push localhost:5000/cdecl/alpine:3.13 The push refers to repository [localhost:5000/cdecl/alpine] c55d5dbdab40: Layer already exists 3.13: digest: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 size: 528 $ docker push localhost:5000/cdecl/alpine:latest The push refers to repository [localhost:5000/cdecl/alpine] 5bfa694cc00a: Layer already exists latest: digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e size: 528 # Catalog list $ curl -s http://localhost:5000/v2/_catalog {"repositories":["cdecl/alpine"]} # Tag 정보 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {"name":"cdecl/alpine","tags":["latest","3.13"]} Image Pull $ docker pull localhost:5000/cdecl/alpine Using default tag: latest latest: Pulling from cdecl/alpine Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e Status: Downloaded newer image for localhost:5000/cdecl/alpine:latest localhost:5000/cdecl/alpine:latest Image Delete Tag 확인 -> Manifests 확인 -> Manifests 이미지 삭제 # Tag 정보 확인 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {"name":"cdecl/alpine","tags":["latest","3.13"]} # Tag의 Manifest 정보확인 - headers 확인 # <registry-url>/v2/<image-path-name>/manifests/<tag> $ curl -s -I -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \ http://localhost:5000/v2/cdecl/alpine/manifests/latest HTTP/1.1 200 OK Content-Length: 528 Content-Type: application/vnd.docker.distribution.manifest.v2+json Docker-Content-Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e Docker-Distribution-Api-Version: registry/2.0 Etag: "sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e" # Manifest 정보로 이미지 삭제 # Docker-Content-Digest: <sha256:로 시작하는 해쉬 문자열> $ curl -s -XDELETE http://localhost:5000/v2/cdecl/alpine/manifests/sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e # 확인 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {"name":"cdecl/alpine","tags":["3.13"]} Delete marked manifests $ curl -sS http://localhost:5000/v2/cdecl/alpine/tags/list {"name":"cdecl/alpine","tags":null} $ docker exec -it registry bin/registry garbage-collect /etc/docker/registry/config.yml cdecl/alpine 0 blobs marked, 3 blobs and 0 manifests eligible for deletion blob eligible for deletion: sha256:81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/81/81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry blob eligible for deletion: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/55/55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry blob eligible for deletion: sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/59/595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry 위 작업으로는 물리적인 데이터가 삭제 안됨 # 물리적인 파일 삭제 $ docker exec -it registry rm -rf /var/lib/registry/docker/registry/v2/repositories/cdecl Script registry-image-delete.sh #!/bin/bash URI="$1" NAME="$2" TAG="$3" if [[ -z "$URI" ]]; then echo "Usage: $0 <URI> <NAME> [<TAG>]" exit -1 fi if [[ -z "$NAME" ]]; then echo "Usage: $0 $URI <NAME> [<TAG>]" echo curl -sS $URI/v2/_catalog | jq -r &#39;.repositories[]&#39; echo exit -1 fi if [[ -z "$TAG" ]]; then echo "Usage: $0 $URI $NAME [<TAG>]" echo curl -sS $URI/v2/$NAME/tags/list | jq -r &#39;.tags[]&#39; echo exit -1 fi MANIFESTS=$(curl -sS -I -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \ $URI/v2/$NAME/manifests/$TAG | grep -i Docker-Content-Digest | awk &#39;{print $2}&#39;) if [[ -z "$MANIFESTS" ]]; then echo "No manifest found for $NAME:$TAG" exit -1 fi echo $MANIFESTS echo echo curl -sS -XDELETE $URI/v2/$NAME/manifests/$MANIFESTS echo '><meta property="og:locale" content="ko-kr"><meta property="og:type" content="article"><meta property="article:section" content="devops"><meta property="article:published_time" content="2021-08-22T00:00:00+09:00"><meta property="article:modified_time" content="2021-08-22T00:00:00+09:00"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Registry"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker Private Registry"><meta name=twitter:description content='Docker Private Registry 구성
Registry 실행

docker-compose.yml

version: &#39;3&#39;

services:
  registry:
    image: registry
    container_name: registry
    restart: always
    ports:
      - 5000:5000
    environment:
      REGISTRY_HTTP_ADDR: 0.0.0.0:5000
    volumes:
      - registry:/var/lib/registry
      - ./config.yml:/etc/docker/registry/config.yml

volumes:
  registry:
# 실행
$ docker-compose up -d

$ curl -s http://localhost:5000/v2/_catalog
{"repositories":[]}

SSL 적용

version: &#39;3&#39;

services:
  registry:
    image: registry
    container_name: private_registry
    restart: always
    ports:
      - 5000:5000
    environment:
      REGISTRY_HTTP_ADDR: 0.0.0.0:5000
      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain-pem.pem
      REGISTRY_HTTP_TLS_KEY: /certs/domain-pem.key
    volumes:
      - registry:/var/lib/registry
      - ./config.yml:/etc/docker/registry/config.yml
      - ./certs:/certs

volumes:
  registry:
Image Push

테스트용 이미지 태깅

# get alpine images
$ docker pull alpine
$ docker pull alpine:3.13
# tagging
$ docker tag alpine localhost:5000/cdecl/alpine:latest
$ docker tag alpine:3.13 localhost:5000/cdecl/alpine:3.13

$ docker images
REPOSITORY                    TAG       IMAGE ID       CREATED        SIZE
alpine                        latest    ae607a46d002   2 weeks ago    5.33MB
localhost:5000/cdecl/alpine   latest    ae607a46d002   2 weeks ago    5.33MB
alpine                        3.13      81efc9693413   2 months ago   5.35MB
localhost:5000/cdecl/alpine   3.13      81efc9693413   2 months ago   5.35MB

Image Push

# image push 
$ docker push localhost:5000/cdecl/alpine:3.13
The push refers to repository [localhost:5000/cdecl/alpine]
c55d5dbdab40: Layer already exists
3.13: digest: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 size: 528

$ docker push localhost:5000/cdecl/alpine:latest
The push refers to repository [localhost:5000/cdecl/alpine]
5bfa694cc00a: Layer already exists
latest: digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e size: 528

# Catalog list 
$ curl -s http://localhost:5000/v2/_catalog
{"repositories":["cdecl/alpine"]}

# Tag 정보 
$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
{"name":"cdecl/alpine","tags":["latest","3.13"]}
Image Pull
$ docker pull localhost:5000/cdecl/alpine
Using default tag: latest
latest: Pulling from cdecl/alpine
Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e
Status: Downloaded newer image for localhost:5000/cdecl/alpine:latest
localhost:5000/cdecl/alpine:latest
Image Delete

Tag 확인 -> Manifests 확인 ->  Manifests 이미지 삭제

# Tag 정보 확인 
$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
{"name":"cdecl/alpine","tags":["latest","3.13"]}

# Tag의 Manifest 정보확인 - headers 확인 
# <registry-url>/v2/<image-path-name>/manifests/<tag>
$ curl -s -I -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
    http://localhost:5000/v2/cdecl/alpine/manifests/latest
HTTP/1.1 200 OK
Content-Length: 528
Content-Type: application/vnd.docker.distribution.manifest.v2+json
Docker-Content-Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e"


# Manifest 정보로 이미지 삭제 
# Docker-Content-Digest: <sha256:로 시작하는 해쉬 문자열> 
$ curl -s -XDELETE http://localhost:5000/v2/cdecl/alpine/manifests/sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e

# 확인
$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
{"name":"cdecl/alpine","tags":["3.13"]}
Delete marked manifests
$ curl -sS http://localhost:5000/v2/cdecl/alpine/tags/list
{"name":"cdecl/alpine","tags":null}

$ docker exec -it registry bin/registry garbage-collect /etc/docker/registry/config.yml
cdecl/alpine

0 blobs marked, 3 blobs and 0 manifests eligible for deletion
blob eligible for deletion: sha256:81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/81/81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802  go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry
blob eligible for deletion: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/55/55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4  go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry
blob eligible for deletion: sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/59/595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43  go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry

위 작업으로는 물리적인 데이터가 삭제 안됨

# 물리적인 파일 삭제 
$ docker exec -it registry rm -rf /var/lib/registry/docker/registry/v2/repositories/cdecl

Script

registry-image-delete.sh

#!/bin/bash

URI="$1"
NAME="$2"
TAG="$3"

if [[ -z "$URI" ]]; then
        echo "Usage: $0 <URI> <NAME> [<TAG>]"
        exit -1
fi

if [[ -z "$NAME" ]]; then
        echo "Usage: $0 $URI <NAME> [<TAG>]"
        echo
        curl -sS $URI/v2/_catalog | jq -r &#39;.repositories[]&#39;
        echo
        exit -1
fi

if [[ -z "$TAG" ]]; then
        echo "Usage: $0 $URI $NAME [<TAG>]"
        echo
        curl -sS $URI/v2/$NAME/tags/list | jq -r &#39;.tags[]&#39;
        echo
        exit -1
fi

MANIFESTS=$(curl -sS -I -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
        $URI/v2/$NAME/manifests/$TAG | grep -i Docker-Content-Digest | awk &#39;{print $2}&#39;)

if [[ -z "$MANIFESTS" ]]; then
        echo "No manifest found for $NAME:$TAG"
        exit -1
fi

echo $MANIFESTS
echo
echo curl -sS -XDELETE $URI/v2/$NAME/manifests/$MANIFESTS
echo
'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Devops","item":"https://cdecl.github.io/devops/"},{"@type":"ListItem","position":2,"name":"Docker Private Registry","item":"https://cdecl.github.io/devops/docker-private-registry/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker Private Registry","name":"Docker Private Registry","description":"Docker Private Registry 구성\nRegistry 실행 docker-compose.yml version: \u0026#39;3\u0026#39; services: registry: image: registry container_name: registry restart: always ports: - 5000:5000 environment: REGISTRY_HTTP_ADDR: 0.0.0.0:5000 volumes: - registry:/var/lib/registry - ./config.yml:/etc/docker/registry/config.yml volumes: registry: # 실행 $ docker-compose up -d $ curl -s http://localhost:5000/v2/_catalog {\u0026#34;repositories\u0026#34;:[]} SSL 적용 version: \u0026#39;3\u0026#39; services: registry: image: registry container_name: private_registry restart: always ports: - 5000:5000 environment: REGISTRY_HTTP_ADDR: 0.0.0.0:5000 REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain-pem.pem REGISTRY_HTTP_TLS_KEY: /certs/domain-pem.key volumes: - registry:/var/lib/registry - ./config.yml:/etc/docker/registry/config.yml - ./certs:/certs volumes: registry: Image Push 테스트용 이미지 태깅 # get alpine images $ docker pull alpine $ docker pull alpine:3.13 # tagging $ docker tag alpine localhost:5000/cdecl/alpine:latest $ docker tag alpine:3.13 localhost:5000/cdecl/alpine:3.13 $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE alpine latest ae607a46d002 2 weeks ago 5.33MB localhost:5000/cdecl/alpine latest ae607a46d002 2 weeks ago 5.33MB alpine 3.13 81efc9693413 2 months ago 5.35MB localhost:5000/cdecl/alpine 3.13 81efc9693413 2 months ago 5.35MB Image Push # image push $ docker push localhost:5000/cdecl/alpine:3.13 The push refers to repository [localhost:5000/cdecl/alpine] c55d5dbdab40: Layer already exists 3.13: digest: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 size: 528 $ docker push localhost:5000/cdecl/alpine:latest The push refers to repository [localhost:5000/cdecl/alpine] 5bfa694cc00a: Layer already exists latest: digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e size: 528 # Catalog list $ curl -s http://localhost:5000/v2/_catalog {\u0026#34;repositories\u0026#34;:[\u0026#34;cdecl/alpine\u0026#34;]} # Tag 정보 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {\u0026#34;name\u0026#34;:\u0026#34;cdecl/alpine\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;latest\u0026#34;,\u0026#34;3.13\u0026#34;]} Image Pull $ docker pull localhost:5000/cdecl/alpine Using default tag: latest latest: Pulling from cdecl/alpine Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e Status: Downloaded newer image for localhost:5000/cdecl/alpine:latest localhost:5000/cdecl/alpine:latest Image Delete Tag 확인 -\u0026gt; Manifests 확인 -\u0026gt; Manifests 이미지 삭제 # Tag 정보 확인 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {\u0026#34;name\u0026#34;:\u0026#34;cdecl/alpine\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;latest\u0026#34;,\u0026#34;3.13\u0026#34;]} # Tag의 Manifest 정보확인 - headers 확인 # \u0026lt;registry-url\u0026gt;/v2/\u0026lt;image-path-name\u0026gt;/manifests/\u0026lt;tag\u0026gt; $ curl -s -I -H \u0026#34;Accept: application/vnd.docker.distribution.manifest.v2+json\u0026#34; \\ http://localhost:5000/v2/cdecl/alpine/manifests/latest HTTP/1.1 200 OK Content-Length: 528 Content-Type: application/vnd.docker.distribution.manifest.v2+json Docker-Content-Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e Docker-Distribution-Api-Version: registry/2.0 Etag: \u0026#34;sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e\u0026#34; # Manifest 정보로 이미지 삭제 # Docker-Content-Digest: \u0026lt;sha256:로 시작하는 해쉬 문자열\u0026gt; $ curl -s -XDELETE http://localhost:5000/v2/cdecl/alpine/manifests/sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e # 확인 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {\u0026#34;name\u0026#34;:\u0026#34;cdecl/alpine\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;3.13\u0026#34;]} Delete marked manifests $ curl -sS http://localhost:5000/v2/cdecl/alpine/tags/list {\u0026#34;name\u0026#34;:\u0026#34;cdecl/alpine\u0026#34;,\u0026#34;tags\u0026#34;:null} $ docker exec -it registry bin/registry garbage-collect /etc/docker/registry/config.yml cdecl/alpine 0 blobs marked, 3 blobs and 0 manifests eligible for deletion blob eligible for deletion: sha256:81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/81/81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry blob eligible for deletion: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/55/55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry blob eligible for deletion: sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/59/595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry 위 작업으로는 물리적인 데이터가 삭제 안됨 # 물리적인 파일 삭제 $ docker exec -it registry rm -rf /var/lib/registry/docker/registry/v2/repositories/cdecl Script registry-image-delete.sh #!/bin/bash URI=\u0026#34;$1\u0026#34; NAME=\u0026#34;$2\u0026#34; TAG=\u0026#34;$3\u0026#34; if [[ -z \u0026#34;$URI\u0026#34; ]]; then echo \u0026#34;Usage: $0 \u0026lt;URI\u0026gt; \u0026lt;NAME\u0026gt; [\u0026lt;TAG\u0026gt;]\u0026#34; exit -1 fi if [[ -z \u0026#34;$NAME\u0026#34; ]]; then echo \u0026#34;Usage: $0 $URI \u0026lt;NAME\u0026gt; [\u0026lt;TAG\u0026gt;]\u0026#34; echo curl -sS $URI/v2/_catalog | jq -r \u0026#39;.repositories[]\u0026#39; echo exit -1 fi if [[ -z \u0026#34;$TAG\u0026#34; ]]; then echo \u0026#34;Usage: $0 $URI $NAME [\u0026lt;TAG\u0026gt;]\u0026#34; echo curl -sS $URI/v2/$NAME/tags/list | jq -r \u0026#39;.tags[]\u0026#39; echo exit -1 fi MANIFESTS=$(curl -sS -I -H \u0026#34;Accept: application/vnd.docker.distribution.manifest.v2+json\u0026#34; \\ $URI/v2/$NAME/manifests/$TAG | grep -i Docker-Content-Digest | awk \u0026#39;{print $2}\u0026#39;) if [[ -z \u0026#34;$MANIFESTS\u0026#34; ]]; then echo \u0026#34;No manifest found for $NAME:$TAG\u0026#34; exit -1 fi echo $MANIFESTS echo echo curl -sS -XDELETE $URI/v2/$NAME/manifests/$MANIFESTS echo ","keywords":["docker","registry"],"articleBody":"Docker Private Registry 구성\nRegistry 실행 docker-compose.yml version: '3' services: registry: image: registry container_name: registry restart: always ports: - 5000:5000 environment: REGISTRY_HTTP_ADDR: 0.0.0.0:5000 volumes: - registry:/var/lib/registry - ./config.yml:/etc/docker/registry/config.yml volumes: registry: # 실행 $ docker-compose up -d $ curl -s http://localhost:5000/v2/_catalog {\"repositories\":[]} SSL 적용 version: '3' services: registry: image: registry container_name: private_registry restart: always ports: - 5000:5000 environment: REGISTRY_HTTP_ADDR: 0.0.0.0:5000 REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain-pem.pem REGISTRY_HTTP_TLS_KEY: /certs/domain-pem.key volumes: - registry:/var/lib/registry - ./config.yml:/etc/docker/registry/config.yml - ./certs:/certs volumes: registry: Image Push 테스트용 이미지 태깅 # get alpine images $ docker pull alpine $ docker pull alpine:3.13 # tagging $ docker tag alpine localhost:5000/cdecl/alpine:latest $ docker tag alpine:3.13 localhost:5000/cdecl/alpine:3.13 $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE alpine latest ae607a46d002 2 weeks ago 5.33MB localhost:5000/cdecl/alpine latest ae607a46d002 2 weeks ago 5.33MB alpine 3.13 81efc9693413 2 months ago 5.35MB localhost:5000/cdecl/alpine 3.13 81efc9693413 2 months ago 5.35MB Image Push # image push $ docker push localhost:5000/cdecl/alpine:3.13 The push refers to repository [localhost:5000/cdecl/alpine] c55d5dbdab40: Layer already exists 3.13: digest: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 size: 528 $ docker push localhost:5000/cdecl/alpine:latest The push refers to repository [localhost:5000/cdecl/alpine] 5bfa694cc00a: Layer already exists latest: digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e size: 528 # Catalog list $ curl -s http://localhost:5000/v2/_catalog {\"repositories\":[\"cdecl/alpine\"]} # Tag 정보 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {\"name\":\"cdecl/alpine\",\"tags\":[\"latest\",\"3.13\"]} Image Pull $ docker pull localhost:5000/cdecl/alpine Using default tag: latest latest: Pulling from cdecl/alpine Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e Status: Downloaded newer image for localhost:5000/cdecl/alpine:latest localhost:5000/cdecl/alpine:latest Image Delete Tag 확인 -\u003e Manifests 확인 -\u003e Manifests 이미지 삭제 # Tag 정보 확인 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {\"name\":\"cdecl/alpine\",\"tags\":[\"latest\",\"3.13\"]} # Tag의 Manifest 정보확인 - headers 확인 # /v2//manifests/ $ curl -s -I -H \"Accept: application/vnd.docker.distribution.manifest.v2+json\" \\ http://localhost:5000/v2/cdecl/alpine/manifests/latest HTTP/1.1 200 OK Content-Length: 528 Content-Type: application/vnd.docker.distribution.manifest.v2+json Docker-Content-Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e Docker-Distribution-Api-Version: registry/2.0 Etag: \"sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e\" # Manifest 정보로 이미지 삭제 # Docker-Content-Digest: $ curl -s -XDELETE http://localhost:5000/v2/cdecl/alpine/manifests/sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e # 확인 $ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list {\"name\":\"cdecl/alpine\",\"tags\":[\"3.13\"]} Delete marked manifests $ curl -sS http://localhost:5000/v2/cdecl/alpine/tags/list {\"name\":\"cdecl/alpine\",\"tags\":null} $ docker exec -it registry bin/registry garbage-collect /etc/docker/registry/config.yml cdecl/alpine 0 blobs marked, 3 blobs and 0 manifests eligible for deletion blob eligible for deletion: sha256:81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/81/81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry blob eligible for deletion: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/55/55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry blob eligible for deletion: sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/59/595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 go.version=go1.11.2 instance.id=d8bbbd10-232a-457a-9ceb-312b7317da5f service=registry 위 작업으로는 물리적인 데이터가 삭제 안됨 # 물리적인 파일 삭제 $ docker exec -it registry rm -rf /var/lib/registry/docker/registry/v2/repositories/cdecl Script registry-image-delete.sh #!/bin/bash URI=\"$1\" NAME=\"$2\" TAG=\"$3\" if [[ -z \"$URI\" ]]; then echo \"Usage: $0 []\" exit -1 fi if [[ -z \"$NAME\" ]]; then echo \"Usage: $0 $URI []\" echo curl -sS $URI/v2/_catalog | jq -r '.repositories[]' echo exit -1 fi if [[ -z \"$TAG\" ]]; then echo \"Usage: $0 $URI $NAME []\" echo curl -sS $URI/v2/$NAME/tags/list | jq -r '.tags[]' echo exit -1 fi MANIFESTS=$(curl -sS -I -H \"Accept: application/vnd.docker.distribution.manifest.v2+json\" \\ $URI/v2/$NAME/manifests/$TAG | grep -i Docker-Content-Digest | awk '{print $2}') if [[ -z \"$MANIFESTS\" ]]; then echo \"No manifest found for $NAME:$TAG\" exit -1 fi echo $MANIFESTS echo echo curl -sS -XDELETE $URI/v2/$NAME/manifests/$MANIFESTS echo ","wordCount":"485","inLanguage":"en","datePublished":"2021-08-22T00:00:00+09:00","dateModified":"2021-08-22T00:00:00+09:00","author":{"@type":"Person","name":"Byung Kyu KIM"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://cdecl.github.io/devops/docker-private-registry/"},"publisher":{"@type":"Organization","name":"cdeclog","logo":{"@type":"ImageObject","url":"https://cdecl.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://cdecl.github.io/ accesskey=h title="cdeclog (Alt + H)">cdeclog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://cdecl.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://cdecl.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://cdecl.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Docker Private Registry</h1><div class=post-meta><span title='2021-08-22 00:00:00 +0900 KST'>August 22, 2021</span>&nbsp;·&nbsp;<span>Byung Kyu KIM</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#registry-%ec%8b%a4%ed%96%89 aria-label="Registry 실행">Registry 실행</a><ul><li><a href=#image-push aria-label="Image Push">Image Push</a></li><li><a href=#image-pull aria-label="Image Pull">Image Pull</a></li><li><a href=#image-delete aria-label="Image Delete">Image Delete</a></li><li><a href=#delete-marked-manifests aria-label="Delete marked manifests">Delete marked manifests</a></li><li><a href=#script aria-label=Script>Script</a></li></ul></li></ul></div></details></div><div class=post-content><p>Docker Private Registry 구성</p><h2 id=registry-실행>Registry 실행<a hidden class=anchor aria-hidden=true href=#registry-실행>#</a></h2><ul><li>docker-compose.yml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>registry</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5000</span>:<span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>REGISTRY_HTTP_ADDR</span>: <span style=color:#ae81ff>0.0.0.0</span>:<span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>registry:/var/lib/registry</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config.yml:/etc/docker/registry/config.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 실행</span>
</span></span><span style=display:flex><span>$ docker-compose up -d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl -s http://localhost:5000/v2/_catalog
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;repositories&#34;</span>:<span style=color:#f92672>[]}</span>
</span></span></code></pre></div><ul><li>SSL 적용</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>private_registry</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5000</span>:<span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>REGISTRY_HTTP_ADDR</span>: <span style=color:#ae81ff>0.0.0.0</span>:<span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>REGISTRY_HTTP_TLS_CERTIFICATE</span>: <span style=color:#ae81ff>/certs/domain-pem.pem</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>REGISTRY_HTTP_TLS_KEY</span>: <span style=color:#ae81ff>/certs/domain-pem.key</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>registry:/var/lib/registry</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config.yml:/etc/docker/registry/config.yml</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./certs:/certs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:
</span></span></code></pre></div><h3 id=image-push>Image Push<a hidden class=anchor aria-hidden=true href=#image-push>#</a></h3><ul><li>테스트용 이미지 태깅</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># get alpine images</span>
</span></span><span style=display:flex><span>$ docker pull alpine
</span></span><span style=display:flex><span>$ docker pull alpine:3.13
</span></span><span style=display:flex><span><span style=color:#75715e># tagging</span>
</span></span><span style=display:flex><span>$ docker tag alpine localhost:5000/cdecl/alpine:latest
</span></span><span style=display:flex><span>$ docker tag alpine:3.13 localhost:5000/cdecl/alpine:3.13
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker images
</span></span><span style=display:flex><span>REPOSITORY                    TAG       IMAGE ID       CREATED        SIZE
</span></span><span style=display:flex><span>alpine                        latest    ae607a46d002   <span style=color:#ae81ff>2</span> weeks ago    5.33MB
</span></span><span style=display:flex><span>localhost:5000/cdecl/alpine   latest    ae607a46d002   <span style=color:#ae81ff>2</span> weeks ago    5.33MB
</span></span><span style=display:flex><span>alpine                        3.13      81efc9693413   <span style=color:#ae81ff>2</span> months ago   5.35MB
</span></span><span style=display:flex><span>localhost:5000/cdecl/alpine   3.13      81efc9693413   <span style=color:#ae81ff>2</span> months ago   5.35MB
</span></span></code></pre></div><ul><li>Image Push</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># image push </span>
</span></span><span style=display:flex><span>$ docker push localhost:5000/cdecl/alpine:3.13
</span></span><span style=display:flex><span>The push refers to repository <span style=color:#f92672>[</span>localhost:5000/cdecl/alpine<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>c55d5dbdab40: Layer already exists
</span></span><span style=display:flex><span>3.13: digest: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4 size: <span style=color:#ae81ff>528</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker push localhost:5000/cdecl/alpine:latest
</span></span><span style=display:flex><span>The push refers to repository <span style=color:#f92672>[</span>localhost:5000/cdecl/alpine<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>5bfa694cc00a: Layer already exists
</span></span><span style=display:flex><span>latest: digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e size: <span style=color:#ae81ff>528</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Catalog list </span>
</span></span><span style=display:flex><span>$ curl -s http://localhost:5000/v2/_catalog
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;repositories&#34;</span>:<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;cdecl/alpine&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Tag 정보 </span>
</span></span><span style=display:flex><span>$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;cdecl/alpine&#34;</span>,<span style=color:#e6db74>&#34;tags&#34;</span>:<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;latest&#34;</span>,<span style=color:#e6db74>&#34;3.13&#34;</span><span style=color:#f92672>]}</span>
</span></span></code></pre></div><h3 id=image-pull>Image Pull<a hidden class=anchor aria-hidden=true href=#image-pull>#</a></h3><pre tabindex=0><code>$ docker pull localhost:5000/cdecl/alpine
Using default tag: latest
latest: Pulling from cdecl/alpine
Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e
Status: Downloaded newer image for localhost:5000/cdecl/alpine:latest
localhost:5000/cdecl/alpine:latest
</code></pre><h3 id=image-delete>Image Delete<a hidden class=anchor aria-hidden=true href=#image-delete>#</a></h3><ul><li>Tag 확인 -> Manifests 확인 -> Manifests 이미지 삭제</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># Tag 정보 확인 </span>
</span></span><span style=display:flex><span>$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;cdecl/alpine&#34;</span>,<span style=color:#e6db74>&#34;tags&#34;</span>:<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;latest&#34;</span>,<span style=color:#e6db74>&#34;3.13&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Tag의 Manifest 정보확인 - headers 확인 </span>
</span></span><span style=display:flex><span><span style=color:#75715e># &lt;registry-url&gt;/v2/&lt;image-path-name&gt;/manifests/&lt;tag&gt;</span>
</span></span><span style=display:flex><span>$ curl -s -I -H <span style=color:#e6db74>&#34;Accept: application/vnd.docker.distribution.manifest.v2+json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    http://localhost:5000/v2/cdecl/alpine/manifests/latest
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>528</span>
</span></span><span style=display:flex><span>Content-Type: application/vnd.docker.distribution.manifest.v2+json
</span></span><span style=display:flex><span>Docker-Content-Digest: sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e
</span></span><span style=display:flex><span>Docker-Distribution-Api-Version: registry/2.0
</span></span><span style=display:flex><span>Etag: <span style=color:#e6db74>&#34;sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Manifest 정보로 이미지 삭제 </span>
</span></span><span style=display:flex><span><span style=color:#75715e># Docker-Content-Digest: &lt;sha256:로 시작하는 해쉬 문자열&gt; </span>
</span></span><span style=display:flex><span>$ curl -s -XDELETE http://localhost:5000/v2/cdecl/alpine/manifests/sha256:bd9137c3bb45dbc40cde0f0e19a8b9064c2bc485466221f5e95eb72b0d0cf82e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 확인</span>
</span></span><span style=display:flex><span>$ curl -s http://localhost:5000/v2/cdecl/alpine/tags/list
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;cdecl/alpine&#34;</span>,<span style=color:#e6db74>&#34;tags&#34;</span>:<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;3.13&#34;</span><span style=color:#f92672>]}</span>
</span></span></code></pre></div><h3 id=delete-marked-manifests>Delete marked manifests<a hidden class=anchor aria-hidden=true href=#delete-marked-manifests>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl -sS http://localhost:5000/v2/cdecl/alpine/tags/list
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;cdecl/alpine&#34;</span>,<span style=color:#e6db74>&#34;tags&#34;</span>:null<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker exec -it registry bin/registry garbage-collect /etc/docker/registry/config.yml
</span></span><span style=display:flex><span>cdecl/alpine
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> blobs marked, <span style=color:#ae81ff>3</span> blobs and <span style=color:#ae81ff>0</span> manifests eligible <span style=color:#66d9ef>for</span> deletion
</span></span><span style=display:flex><span>blob eligible <span style=color:#66d9ef>for</span> deletion: sha256:81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Deleting blob: /docker/registry/v2/blobs/sha256/81/81efc9693413c6292235ea2c29ea07c149701140b98df6c1998bb91d41acf802  go.version<span style=color:#f92672>=</span>go1.11.2 instance.id<span style=color:#f92672>=</span>d8bbbd10-232a-457a-9ceb-312b7317da5f service<span style=color:#f92672>=</span>registry
</span></span><span style=display:flex><span>blob eligible <span style=color:#66d9ef>for</span> deletion: sha256:55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Deleting blob: /docker/registry/v2/blobs/sha256/55/55fc95a51d97f7b76b124f3b581a58ebf5555d12574f16087de3971a12724dd4  go.version<span style=color:#f92672>=</span>go1.11.2 instance.id<span style=color:#f92672>=</span>d8bbbd10-232a-457a-9ceb-312b7317da5f service<span style=color:#f92672>=</span>registry
</span></span><span style=display:flex><span>blob eligible <span style=color:#66d9ef>for</span> deletion: sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> Deleting blob: /docker/registry/v2/blobs/sha256/59/595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43  go.version<span style=color:#f92672>=</span>go1.11.2 instance.id<span style=color:#f92672>=</span>d8bbbd10-232a-457a-9ceb-312b7317da5f service<span style=color:#f92672>=</span>registry
</span></span></code></pre></div><ul><li>위 작업으로는 물리적인 데이터가 삭제 안됨</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 물리적인 파일 삭제 </span>
</span></span><span style=display:flex><span>$ docker exec -it registry rm -rf /var/lib/registry/docker/registry/v2/repositories/cdecl
</span></span></code></pre></div><hr><h3 id=script>Script<a hidden class=anchor aria-hidden=true href=#script>#</a></h3><ul><li>registry-image-delete.sh</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>URI<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$3<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -z <span style=color:#e6db74>&#34;</span>$URI<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Usage: </span>$0<span style=color:#e6db74> &lt;URI&gt; &lt;NAME&gt; [&lt;TAG&gt;]&#34;</span>
</span></span><span style=display:flex><span>        exit -1
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -z <span style=color:#e6db74>&#34;</span>$NAME<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Usage: </span>$0<span style=color:#e6db74> </span>$URI<span style=color:#e6db74> &lt;NAME&gt; [&lt;TAG&gt;]&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        curl -sS $URI/v2/_catalog | jq -r <span style=color:#e6db74>&#39;.repositories[]&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        exit -1
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -z <span style=color:#e6db74>&#34;</span>$TAG<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Usage: </span>$0<span style=color:#e6db74> </span>$URI<span style=color:#e6db74> </span>$NAME<span style=color:#e6db74> [&lt;TAG&gt;]&#34;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        curl -sS $URI/v2/$NAME/tags/list | jq -r <span style=color:#e6db74>&#39;.tags[]&#39;</span>
</span></span><span style=display:flex><span>        echo
</span></span><span style=display:flex><span>        exit -1
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MANIFESTS<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -sS -I -H <span style=color:#e6db74>&#34;Accept: application/vnd.docker.distribution.manifest.v2+json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>        $URI/v2/$NAME/manifests/$TAG | grep -i Docker-Content-Digest | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -z <span style=color:#e6db74>&#34;</span>$MANIFESTS<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;No manifest found for </span>$NAME<span style=color:#e6db74>:</span>$TAG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        exit -1
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo $MANIFESTS
</span></span><span style=display:flex><span>echo
</span></span><span style=display:flex><span>echo curl -sS -XDELETE $URI/v2/$NAME/manifests/$MANIFESTS
</span></span><span style=display:flex><span>echo
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://cdecl.github.io/tags/docker/>Docker</a></li><li><a href=https://cdecl.github.io/tags/registry/>Registry</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://cdecl.github.io/>cdeclog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>